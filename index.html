<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>曲亭札记 - 武侠语C群</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'STKaiti', serif;
        }
        
        body {
            background: #f5f0e1 url('https://img.zcool.cn/community/01a1a55d15c8bba8012187f4b4a7a7.jpg@1280w_1l_2o_100sh.jpg') no-repeat center/cover;
            min-height: 100vh;
            padding: 20px;
            color: #3e2723;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            border: 2px solid #8b4513;
            position: relative;
            overflow: hidden;
        }
        
        /* 顶部装饰 */
        .header-decoration {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, #8b4513, #d4af37, #8b4513);
            border-radius: 5px 5px 0 0;
        }
        
        /* 标题和导航 */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px dashed #8b4513;
            position: relative;
        }
        
        h1 {
            color: #8b4513;
            font-size: 2.8rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 5px;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .nav-btn {
            background: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn:hover {
            background: #6d4c41;
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        
        .nav-btn.admin {
            background: #c62828;
            position: absolute;
            top: 20px;
            left: 20px;
            display: none; /* 默认隐藏，根据权限显示 */
        }
        
        .nav-btn.admin:hover {
            background: #a11515;
        }

        /* 用户按钮区域 */
        .user-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .logged-in-buttons {
            display: none;
            gap: 20px;
        }

        .nav-btn.disabled {
            background: #bcaaa4;
            cursor: not-allowed;
        }

        .nav-btn.disabled:hover {
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* 主要内容区 */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        
        /* 武林榜样式 */
        .ranking-panel {
            background: rgba(139, 69, 19, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #bcaaa4;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .ranking-header {
            text-align: center;
            color: #8b4513;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d4af37;
        }
        
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            transition: all 0.3s;
            border: 1px solid #e0d6c3;
        }
        
        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-color: #d4af37;
        }
        
        .rank {
            font-size: 1.3rem;
            font-weight: bold;
            width: 30px;
            text-align: center;
            margin-right: 10px;
        }
        
        .rank-1 { color: #d4af37; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #8b4513;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: bold;
            color: #5d4037;
            font-size: 1.1rem;
        }
        
        .player-sect {
            font-size: 0.9rem;
            color: #8b4513;
        }
        
        /* 功能按钮区域 */
        .functions-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 20px;
        }
        
        .func-card {
            background: linear-gradient(145deg, #e8dfc8, #d9d0b8);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s;
            border: 1px solid #bcaaa4;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .func-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(145deg, #d9d0b8, #c9c0a8);
            border-color: #d4af37;
        }
        
        .func-icon {
            font-size: 3.5rem;
            color: #8b4513;
            margin-bottom: 15px;
        }
        
        .func-title {
            font-size: 1.8rem;
            color: #5d4037;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .func-desc {
            font-size: 1rem;
            color: #7d5d47;
        }
        
        /* 底部装饰 */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #8b4513;
            color: #5d4037;
            font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .functions-panel {
                grid-template-columns: 1fr;
            }

            .user-buttons {
                flex-direction: column;
                align-items: center;
            }

            .logged-in-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 600px) {
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .func-title {
                font-size: 1.5rem;
            }
        }

        /* 签到奖励动画 */
        @keyframes rewardPop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0; }
        }

        .reward-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 69, 19, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            z-index: 1000;
            animation: rewardPop 2s forwards;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* 加载动画 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #5d4037;
        }
        
        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-decoration"></div>
        
        <div class="header">
            <h1>曲亭札记</h1>
            
            <!-- 管理员按钮（根据权限动态显示） -->
            <button class="nav-btn admin" id="adminBtn">
                <i class="fas fa-crown"></i> 管理
            </button>
            
            <div class="nav-buttons">
                <!-- 用户按钮区域 -->
                <div class="user-buttons">
                    <!-- 未登录状态 -->
                    <button class="nav-btn" id="enterBtn">
                        <i class="fas fa-door-open"></i> 进入江湖
                    </button>
                    
                    <!-- 已登录状态 -->
                    <div class="logged-in-buttons" id="loggedInButtons">
                        <button class="nav-btn" id="dailySignBtn">
                            <i class="fas fa-calendar-check"></i> 每日签到
                        </button>
                        <button class="nav-btn" id="profileBtn">
                            <i class="fas fa-user"></i> 我的属性
                        </button>
                    </div>
                </div>
                
                <!-- 其他导航按钮 -->
                <button class="nav-btn" onclick="location.href='rules.html'">
                    <i class="fas fa-book"></i> 江湖规则
                </button>
                <button class="nav-btn" onclick="location.href='ranking.html'">
                    <i class="fas fa-trophy"></i> 排行榜
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- 武林榜区域 -->
            <div class="ranking-panel">
                <div class="ranking-header">武林榜</div>
                <div class="ranking-list" id="rankingList">
                    <div class="loading">
                        <i class="fas fa-spinner"></i> 加载中...
                    </div>
                </div>
            </div>
            
            <!-- 功能按钮区域 -->
            <div class="functions-panel">
                <div class="func-card" onclick="location.href='rules.html'">
                    <div class="func-icon"><i class="fas fa-scroll"></i></div>
                    <div class="func-title">江湖规则</div>
                    <div class="func-desc">了解各门派规矩与江湖道义</div>
                </div>
                
                <div class="func-card" onclick="location.href='teahouse.html'">
                    <div class="func-icon"><i class="fas fa-mug-hot"></i></div>
                    <div class="func-title">江湖茶馆</div>
                    <div class="func-desc">品茶论道，结交江湖好友</div>
                </div>
                
                <div class="func-card" onclick="location.href='trade.html'">
                    <div class="func-icon"><i class="fas fa-coins"></i></div>
                    <div class="func-title">金枢巷</div>
                    <div class="func-desc">交易物品，互通有无</div>
                </div>
                
                <div class="func-card" onclick="location.href='ranking.html'">
                    <div class="func-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="func-title">排行榜</div>
                    <div class="func-desc">查看武林高手排名</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>武侠语C群 · 曲亭札记© 2025 | 江湖路远，侠义长存</p>
        </div>
    </div>

    <!-- LeanCloud SDK -->
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="data.js"></script>
    
    <script>
        // 渲染武林榜列表
        async function renderRankingList() {
            const container = document.getElementById('rankingList');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>';
            
            try {
                const allChars = await WuxiaData.getAllCharacters();
                const characters = Object.values(allChars);
                
                if (characters.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;">暂无玩家数据</div>';
                    return;
                }
                
                // 按战斗力排序
                const sortedPlayers = characters
                    .map(char => ({
                        ...char,
                        power: WuxiaData.calculatePower(char)
                    }))
                    .sort((a, b) => b.power - a.power)
                    .slice(0, 10); // 只显示前10名
                
                container.innerHTML = '';
                
                sortedPlayers.forEach((player, index) => {
                    const rankClass = index < 3 ? `rank-${index+1}` : '';
                    const sectInfo = WuxiaData.sects[player.sect] || { name: '未知', color: '' };
                    
                    const item = document.createElement('div');
                    item.className = 'ranking-item';
                    item.innerHTML = `
                        <div class="rank ${rankClass}">${index+1}</div>
                        <img src="${player.avatar}" class="player-avatar" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%238b4513\'/><text x=\'50\' y=\'55\' font-family=\'Microsoft YaHei\' font-size=\'16\' fill=\'white\' text-anchor=\'middle\'>${player.name.charAt(0)}</text></svg>'">
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-sect">${sectInfo.name} · ${player.power || 0}战力</div>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('渲染排行榜失败:', error);
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#c62828;">加载失败，请刷新重试</div>';
            }
        }

        // 显示签到奖励通知
        function showRewardNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'reward-notification';
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // 2秒后自动移除
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // 更新登录状态
        async function updateLoginStatus() {
            const user = await WuxiaData.getCurrentUser();
            const isLoggedIn = user !== null;
            
            // 切换按钮显示
            document.getElementById('enterBtn').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('loggedInButtons').style.display = isLoggedIn ? 'flex' : 'none';
            
            // 检查管理员权限
            if(isLoggedIn && user.isAdmin) {
                document.getElementById('adminBtn').style.display = 'flex';
            } else {
                document.getElementById('adminBtn').style.display = 'none';
            }
            
            // 检查今日是否已签到
            if(isLoggedIn) {
                const today = new Date().toDateString();
                const signedToday = user.lastSignDate === today;
                
                const signBtn = document.getElementById('dailySignBtn');
                signBtn.disabled = signedToday;
                signBtn.classList.toggle('disabled', signedToday);
                
                // 设置我的属性按钮点击事件
                document.getElementById('profileBtn').onclick = function() {
                    location.href = 'profile.html';
                };
            }
        }

        // 签到功能
        document.getElementById('dailySignBtn').addEventListener('click', async function() {
            const user = await WuxiaData.getCurrentUser();
            if(!user) return;
            
            const today = new Date().toDateString();
            if(user.lastSignDate === today) {
                alert('今日已签到！');
                return;
            }
            
            // 随机奖励 (10-100两银子，10-100经验)
            const moneyReward = Math.floor(Math.random() * 91) + 10;
            const expReward = Math.floor(Math.random() * 91) + 10;
            
            // 更新用户数据
            user.money += moneyReward;
            user.exp += expReward;
            user.lastSignDate = today;
            
            // 检查升级 (每1000经验升1级，等级数字减小)
            let levelUp = false;
            while(user.exp >= 1000 && user.level > 1) {
                user.exp -= 1000;
                user.level -= 1;
                levelUp = true;
            }
            
            // 保存数据
            const saveSuccess = await WuxiaData.saveCharacter(user.phone, user);
            
            if(saveSuccess) {
                // 显示奖励
                let rewardMessage = `签到成功！<br>获得 ${moneyReward}两银子 + ${expReward}点经验`;
                if(levelUp) {
                    rewardMessage += `<br><strong>境界突破！当前等级：${user.level}级</strong>`;
                }
                
                showRewardNotification(rewardMessage);
                updateLoginStatus();
                renderRankingList(); // 刷新排行榜
            } else {
                alert('签到失败，请重试');
            }
        });

        // 进入江湖按钮事件
        document.getElementById('enterBtn').addEventListener('click', function() {
            location.href = 'enter.html';
        });

        // 管理员按钮事件
        document.getElementById('adminBtn').addEventListener('click', function() {
            location.href = 'admin.html';
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化LeanCloud
            WuxiaData.init();
            
            // 加载数据
            await updateLoginStatus();
            await renderRankingList();
            
            // 每5分钟自动刷新排行榜
            setInterval(renderRankingList, 5 * 60 * 1000);
        });
    </script>
</body>
</html>